(function(E,w){typeof exports=="object"&&typeof module<"u"?w(exports):typeof define=="function"&&define.amd?define(["exports"],w):(E=typeof globalThis<"u"?globalThis:E||self,w(E.OSDTextLayer={}))})(this,function(E){"use strict";var w=(t=>(t.POLYGON="POLYGON",t.RECTANGLE="RECTANGLE",t))(w||{});const $=(t,e)=>e,mt={area:t=>{const{points:e}=t.geometry;let n=0,o=e.length-1;for(let i=0;i<e.length;i++)n+=(e[o][0]+e[i][0])*(e[o][1]-e[i][1]),o=i;return Math.abs(.5*n)},intersects:(t,e,n)=>{const{points:o}=t.geometry;let i=!1;for(let u=0,r=o.length-1;u<o.length;r=u++){const l=o[u][0],s=o[u][1],f=o[r][0],a=o[r][1];s>n!=a>n&&e<(f-l)*(n-s)/(a-s)+l&&(i=!i)}return i}};$(w.POLYGON,mt);const pt={area:t=>t.geometry.w*t.geometry.h,intersects:(t,e,n)=>e>=t.geometry.x&&e<=t.geometry.x+t.geometry.w&&n>=t.geometry.y&&n<=t.geometry.y+t.geometry.h};$(w.RECTANGLE,pt);const gt=[];for(let t=0;t<256;++t)gt.push((t+256).toString(16).slice(1));typeof crypto<"u"&&crypto.randomUUID&&crypto.randomUUID.bind(crypto),((t=21)=>crypto.getRandomValues(new Uint8Array(t)).reduce((e,n)=>(n&=63,n<36?e+=n.toString(36):n<62?e+=(n-26).toString(36).toUpperCase():n>62?e+="-":e+="_",e),""))();const _t=t=>{const e=[];for(const n of t.querySelectorAll("String")){const o=n.getAttribute("ID"),i=n.getAttribute("CONTENT"),u=parseFloat(n.getAttribute("HPOS")),r=parseFloat(n.getAttribute("VPOS")),l=parseFloat(n.getAttribute("WIDTH")),s=parseFloat(n.getAttribute("HEIGHT")),f=u+l,a=r+s;e.push({id:o,bodies:[{id:o,annotation:o,purpose:"transcribing",value:i}],target:{annotation:o,selector:{type:w.RECTANGLE,geometry:{bounds:{minX:u,minY:r,maxX:f,maxY:a},x:u,y:r,w:l,h:s}}}})}return e},bt=t=>{const e=new DOMParser().parseFromString(t,"application/xml"),n=[];for(const o of e.querySelectorAll("TextLine"))n.push(..._t(o));return n};function O(){}function tt(t){return t()}function et(){return Object.create(null)}function C(t){t.forEach(tt)}function nt(t){return typeof t=="function"}function D(t,e){return t!=t?e==e:t!==e||t&&typeof t=="object"||typeof t=="function"}function yt(t){return Object.keys(t).length===0}function L(t,e){t.appendChild(e)}function N(t,e,n){t.insertBefore(e,n||null)}function A(t){t.parentNode&&t.parentNode.removeChild(t)}function ot(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function P(t){return document.createElement(t)}function Y(t){return document.createTextNode(t)}function U(){return Y("")}function b(t,e,n){n==null?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function wt(t){return Array.from(t.childNodes)}function it(t,e){e=""+e,t.data!==e&&(t.data=e)}function S(t,e,n){t.classList[n?"add":"remove"](e)}let I;function x(t){I=t}function St(){if(!I)throw new Error("Function called outside component initialization");return I}function vt(t){St().$$.on_mount.push(t)}const T=[],X=[];let M=[];const rt=[],Et=Promise.resolve();let V=!1;function Ot(){V||(V=!0,Et.then(lt))}function q(t){M.push(t)}const W=new Set;let z=0;function lt(){if(z!==0)return;const t=I;do{try{for(;z<T.length;){const e=T[z];z++,x(e),At(e.$$)}}catch(e){throw T.length=0,z=0,e}for(x(null),T.length=0,z=0;X.length;)X.pop()();for(let e=0;e<M.length;e+=1){const n=M[e];W.has(n)||(W.add(n),n())}M.length=0}while(T.length);for(;rt.length;)rt.pop()();V=!1,W.clear(),x(t)}function At(t){if(t.fragment!==null){t.update(),C(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(q)}}function kt(t){const e=[],n=[];M.forEach(o=>t.indexOf(o)===-1?e.push(o):n.push(o)),n.forEach(o=>o()),M=e}const H=new Set;let k;function R(){k={r:0,c:[],p:k}}function G(){k.r||C(k.c),k=k.p}function p(t,e){t&&t.i&&(H.delete(t),t.i(e))}function _(t,e,n,o){if(t&&t.o){if(H.has(t))return;H.add(t),k.c.push(()=>{H.delete(t),o&&(n&&t.d(1),o())}),t.o(e)}else o&&o()}function st(t){t&&t.c()}function Z(t,e,n,o){const{fragment:i,after_update:u}=t.$$;i&&i.m(e,n),o||q(()=>{const r=t.$$.on_mount.map(tt).filter(nt);t.$$.on_destroy?t.$$.on_destroy.push(...r):C(r),t.$$.on_mount=[]}),u.forEach(q)}function J(t,e){const n=t.$$;n.fragment!==null&&(kt(n.after_update),C(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function Lt(t,e){t.$$.dirty[0]===-1&&(T.push(t),Ot(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}function K(t,e,n,o,i,u,r,l=[-1]){const s=I;x(t);const f=t.$$={fragment:null,ctx:[],props:u,update:O,not_equal:i,bound:et(),on_mount:[],on_destroy:[],on_disconnect:[],before_update:[],after_update:[],context:new Map(e.context||(s?s.$$.context:[])),callbacks:et(),dirty:l,skip_bound:!1,root:e.target||s.$$.root};r&&r(f.root);let a=!1;if(f.ctx=n?n(t,e.props||{},(h,g,...d)=>{const c=d.length?d[0]:g;return f.ctx&&i(f.ctx[h],f.ctx[h]=c)&&(!f.skip_bound&&f.bound[h]&&f.bound[h](c),a&&Lt(t,h)),g}):[],f.update(),a=!0,C(f.before_update),f.fragment=o?o(f.ctx):!1,e.target){if(e.hydrate){const h=wt(e.target);f.fragment&&f.fragment.l(h),h.forEach(A)}else f.fragment&&f.fragment.c();e.intro&&p(t.$$.fragment),Z(t,e.target,e.anchor,e.customElement),lt()}x(s)}class Q{$destroy(){J(this,1),this.$destroy=O}$on(e,n){if(!nt(n))return O;const o=this.$$.callbacks[e]||(this.$$.callbacks[e]=[]);return o.push(n),()=>{const i=o.indexOf(n);i!==-1&&o.splice(i,1)}}$set(e){this.$$set&&!yt(e)&&(this.$$.skip_bound=!0,this.$$set(e),this.$$.skip_bound=!1)}}function Nt(t){let e,n,o=t[1].label(t[0])+"",i,u,r;return{c(){e=P("div"),n=P("span"),i=Y(o),u=Y(" "),b(e,"class","annotation"),b(e,"style",r=`left:${t[8]}px; top:${t[7]}px; width: ${t[4]}px; height: ${t[3]}px; transform: scale(${t[6]}, ${t[5]})`)},m(l,s){N(l,e,s),L(e,n),L(n,i),t[10](n),L(e,u)},p(l,[s]){s&3&&o!==(o=l[1].label(l[0])+"")&&it(i,o),s&504&&r!==(r=`left:${l[8]}px; top:${l[7]}px; width: ${l[4]}px; height: ${l[3]}px; transform: scale(${l[6]}, ${l[5]})`)&&b(e,"style",r)},i:O,o:O,d(l){l&&A(e),t[10](null)}}}function Tt(t,e,n){let o,i,u,r,l,s,f,a,{annotation:h}=e,{opts:g}=e;function d(c){X[c?"unshift":"push"](()=>{a=c,n(2,a)})}return t.$$set=c=>{"annotation"in c&&n(0,h=c.annotation),"opts"in c&&n(1,g=c.opts)},t.$$.update=()=>{t.$$.dirty&1&&n(9,o=h.target.selector.geometry.bounds),t.$$.dirty&512&&n(8,i=o.minX),t.$$.dirty&512&&n(7,u=o.minY),t.$$.dirty&512&&n(4,r=o.maxX-o.minX),t.$$.dirty&512&&n(3,l=o.maxY-o.minY),t.$$.dirty&20&&n(6,s=a?r/a.offsetWidth:1),t.$$.dirty&12&&n(5,f=a?l/a.offsetHeight:1)},[h,g,a,l,r,f,s,u,i,o,d]}class Mt extends Q{constructor(e){super(),K(this,e,Tt,Nt,D,{annotation:0,opts:1})}}function zt(t){let e,n,o=t[1].label(t[0])+"",i,u,r;return{c(){e=P("div"),n=P("span"),i=Y(o),u=Y(" "),b(e,"class","annotation"),b(e,"style",r=t[6](t[5],t[4],t[2]))},m(l,s){N(l,e,s),L(e,n),L(n,i),t[9](n),L(e,u)},p(l,[s]){s&3&&o!==(o=l[1].label(l[0])+"")&&it(i,o),s&52&&r!==(r=l[6](l[5],l[4],l[2]))&&b(e,"style",r)},i:O,o:O,d(l){l&&A(e),t[9](null)}}}function Ct(t,e,n){let o,i,u,r,{annotation:l}=e,{opts:s}=e,{scale:f}=e,{imageSize:a}=e;const h=(d,c,y)=>{const v=(s.offsetX||0)/y,m=(s.offsetY||0)/y;if(s.position==="topleft"){const j=a[1]-c;return`left:${d+v}px; bottom:${j}px; transform: scale(${1/y})`}else return`left:${d+v}px; top:${c+m}px; transform: scale(${1/y})`};function g(d){X[d?"unshift":"push"](()=>{r=d,n(3,r)})}return t.$$set=d=>{"annotation"in d&&n(0,l=d.annotation),"opts"in d&&n(1,s=d.opts),"scale"in d&&n(2,f=d.scale),"imageSize"in d&&n(7,a=d.imageSize)},t.$$.update=()=>{t.$$.dirty&1&&n(8,o=l.target.selector.geometry.bounds),t.$$.dirty&256&&n(5,i=o.minX),t.$$.dirty&258&&n(4,u=s.position==="topleft"?o.minY:o.maxY)},[l,s,f,r,u,i,h,a,o,g]}class Pt extends Q{constructor(e){super(),K(this,e,Ct,zt,D,{annotation:0,opts:1,scale:2,imageSize:7})}}function ft(t,e,n){const o=t.slice();return o[11]=e[n],o}function ut(t,e,n){const o=t.slice();return o[11]=e[n],o}function at(t){let e,n,o,i,u;const r=[It,Yt],l=[];function s(f,a){return f[0].mode!=="fillBounds"?0:1}return n=s(t),o=l[n]=r[n](t),{c(){e=P("div"),o.c(),b(e,"style",i=`transform:${t[2]}; width: ${t[5]}px; height: ${t[6]}px`),b(e,"class","a9s-annotationlayer a9s-osd-textlayer"),S(e,"fixed-size",t[0].mode!=="fillBounds"),S(e,"fill-bounds",t[0].mode==="fillBounds"),S(e,"bottomleft",t[0].position!=="topleft"),S(e,"topleft",t[0].position==="topleft")},m(f,a){N(f,e,a),l[n].m(e,null),u=!0},p(f,a){let h=n;n=s(f),n===h?l[n].p(f,a):(R(),_(l[h],1,1,()=>{l[h]=null}),G(),o=l[n],o?o.p(f,a):(o=l[n]=r[n](f),o.c()),p(o,1),o.m(e,null)),(!u||a&100&&i!==(i=`transform:${f[2]}; width: ${f[5]}px; height: ${f[6]}px`))&&b(e,"style",i),(!u||a&1)&&S(e,"fixed-size",f[0].mode!=="fillBounds"),(!u||a&1)&&S(e,"fill-bounds",f[0].mode==="fillBounds"),(!u||a&1)&&S(e,"bottomleft",f[0].position!=="topleft"),(!u||a&1)&&S(e,"topleft",f[0].position==="topleft")},i(f){u||(p(o),u=!0)},o(f){_(o),u=!1},d(f){f&&A(e),l[n].d()}}}function Yt(t){let e,n,o=t[4],i=[];for(let r=0;r<o.length;r+=1)i[r]=ct(ft(t,o,r));const u=r=>_(i[r],1,1,()=>{i[r]=null});return{c(){for(let r=0;r<i.length;r+=1)i[r].c();e=U()},m(r,l){for(let s=0;s<i.length;s+=1)i[s]&&i[s].m(r,l);N(r,e,l),n=!0},p(r,l){if(l&17){o=r[4];let s;for(s=0;s<o.length;s+=1){const f=ft(r,o,s);i[s]?(i[s].p(f,l),p(i[s],1)):(i[s]=ct(f),i[s].c(),p(i[s],1),i[s].m(e.parentNode,e))}for(R(),s=o.length;s<i.length;s+=1)u(s);G()}},i(r){if(!n){for(let l=0;l<o.length;l+=1)p(i[l]);n=!0}},o(r){i=i.filter(Boolean);for(let l=0;l<i.length;l+=1)_(i[l]);n=!1},d(r){ot(i,r),r&&A(e)}}}function It(t){let e,n,o=t[4],i=[];for(let r=0;r<o.length;r+=1)i[r]=dt(ut(t,o,r));const u=r=>_(i[r],1,1,()=>{i[r]=null});return{c(){for(let r=0;r<i.length;r+=1)i[r].c();e=U()},m(r,l){for(let s=0;s<i.length;s+=1)i[s]&&i[s].m(r,l);N(r,e,l),n=!0},p(r,l){if(l&121){o=r[4];let s;for(s=0;s<o.length;s+=1){const f=ut(r,o,s);i[s]?(i[s].p(f,l),p(i[s],1)):(i[s]=dt(f),i[s].c(),p(i[s],1),i[s].m(e.parentNode,e))}for(R(),s=o.length;s<i.length;s+=1)u(s);G()}},i(r){if(!n){for(let l=0;l<o.length;l+=1)p(i[l]);n=!0}},o(r){i=i.filter(Boolean);for(let l=0;l<i.length;l+=1)_(i[l]);n=!1},d(r){ot(i,r),r&&A(e)}}}function ct(t){let e,n;return e=new Mt({props:{annotation:t[11],opts:t[0]}}),{c(){st(e.$$.fragment)},m(o,i){Z(e,o,i),n=!0},p(o,i){const u={};i&16&&(u.annotation=o[11]),i&1&&(u.opts=o[0]),e.$set(u)},i(o){n||(p(e.$$.fragment,o),n=!0)},o(o){_(e.$$.fragment,o),n=!1},d(o){J(e,o)}}}function dt(t){let e,n;return e=new Pt({props:{imageSize:[t[5],t[6]],annotation:t[11],opts:t[0],scale:t[3]}}),{c(){st(e.$$.fragment)},m(o,i){Z(e,o,i),n=!0},p(o,i){const u={};i&96&&(u.imageSize=[o[5],o[6]]),i&16&&(u.annotation=o[11]),i&1&&(u.opts=o[0]),i&8&&(u.scale=o[3]),e.$set(u)},i(o){n||(p(e.$$.fragment,o),n=!0)},o(o){_(e.$$.fragment,o),n=!1},d(o){J(e,o)}}}function xt(t){let e,n,o=t[1]&&at(t);return{c(){o&&o.c(),e=U()},m(i,u){o&&o.m(i,u),N(i,e,u),n=!0},p(i,[u]){i[1]?o?(o.p(i,u),u&2&&p(o,1)):(o=at(i),o.c(),p(o,1),o.m(e.parentNode,e)):o&&(R(),_(o,1,1,()=>{o=null}),G())},i(i){n||(p(o),n=!0)},o(i){_(o),n=!1},d(i){o&&o.d(i),i&&A(e)}}}function Bt(t,e,n){let{state:o}=e,{viewer:i}=e,{opts:u}=e,{visible:r=!0}=e;const{store:l}=o;let s,f,a=[],h,g;const d=()=>{const c=i.viewport.viewportToImageRectangle(i.viewport.getBounds(!0)),y=i.viewport.getContainerSize().x,v=i.viewport.getZoom(!0);n(3,f=v*y/i.world.getContentFactor());const m=Math.PI*i.viewport.getRotation()/180,j=-c.x*f,ht=-c.y*f;let B,F;m>0&&m<=Math.PI/2?(B=c.height*f,F=0):m>Math.PI/2&&m<=Math.PI?(B=c.width*f,F=c.height*f):m>Math.PI&&m<=Math.PI*1.5?(B=0,F=c.width*f):(B=0,F=0);const Rt=B+j*Math.cos(m)-ht*Math.sin(m),Gt=F+j*Math.sin(m)+ht*Math.cos(m);n(2,s=`translate(${Rt}px, ${Gt}px) rotate(${m}) scale(${f})`)};return vt(()=>{const c=()=>{const{x:v,y:m}=i.world.getItemAt(0).source.dimensions;n(5,h=v),n(6,g=m)};i.addHandler("open",c),i.addHandler("update-viewport",d);const y=v=>{n(4,a=v.state),d()};return l.observe(y),()=>{i.removeHandler("open",c),i.removeHandler("update-viewport",d),l.unobserve(y)}}),t.$$set=c=>{"state"in c&&n(7,o=c.state),"viewer"in c&&n(8,i=c.viewer),"opts"in c&&n(0,u=c.opts),"visible"in c&&n(1,r=c.visible)},[u,r,s,f,a,h,g,o,i]}class Ft extends Q{constructor(e){super(),K(this,e,Bt,xt,D,{state:7,viewer:8,opts:0,visible:1})}}const Dt="",Xt=(t,e)=>{const{viewer:n,state:o}=t;let i=!0;const u=new Ft({target:n.element.querySelector(".openseadragon-canvas"),props:{state:o,viewer:n,opts:e}});return{isVisible:()=>i,loadOCR:(a,h="ALTO")=>fetch(a).then(g=>g.text()).then(g=>{const d=bt(g);t.setAnnotations(d)}),setVisible:a=>{i=a,u.$$set({visible:a})},unmount:()=>u.$destroy()}},Ht=t=>{var e;return(e=t.bodies.find(n=>n.purpose==="transcribing"))==null?void 0:e.value};E.mountExtension=Xt,E.transcriptionLabel=Ht,Object.defineProperty(E,Symbol.toStringTag,{value:"Module"})});
//# sourceMappingURL=annotorious-openseadragon-textlayer.umd.js.map
